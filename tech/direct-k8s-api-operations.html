<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="K8s API, kubectl, ç›´æ¥æ“ä½œAPI, æ€§èƒ½ä¼˜åŒ–, çµæ´»æ€§, å¹¶å‘è¯·æ±‚, é›¶ä¾èµ–, Watchæœºåˆ¶, æ‰¹é‡æ“ä½œ, CI/CDæµæ°´çº¿" />
  <meta name="description" content="ç›´æ¥æ“ä½œKubernetes APIå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½å’Œçµæ´»æ€§ï¼Œå‡å°‘ä¸­é—´å±‚ï¼Œæ”¯æŒå¹¶å‘å’Œæµå¼å¤„ç†ã€‚åœ¨CI/CDã€è‡ªå®šä¹‰æ§åˆ¶å™¨å’Œç›‘æ§ç­‰åœºæ™¯ä¸‹ï¼Œç›´æ¥è°ƒç”¨APIæ˜¯æ›´ä¼˜é€‰æ‹©ã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´ä¸åŠ ç­" href="https://blog.opsnot.com/feed.xml" />
  <link rel="stylesheet" href="https://blog.opsnot.com/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>ç»•è¿‡kubectlï¼Œç›´æ¥æ“ä½œK8s APIçš„æ­£ç¡®å§¿åŠ¿ï¼</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´ä¸åŠ ç­" />
  <meta property="og:url" content="https://blog.opsnot.comtech/direct-k8s-api-operations.html" />
  <meta property="og:title" content="ç»•è¿‡kubectlï¼Œç›´æ¥æ“ä½œK8s APIçš„æ­£ç¡®å§¿åŠ¿ï¼" />
  <meta property="og:description" content="ç›´æ¥æ“ä½œKubernetes APIå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½å’Œçµæ´»æ€§ï¼Œå‡å°‘ä¸­é—´å±‚ï¼Œæ”¯æŒå¹¶å‘å’Œæµå¼å¤„ç†ã€‚åœ¨CI/CDã€è‡ªå®šä¹‰æ§åˆ¶å™¨å’Œç›‘æ§ç­‰åœºæ™¯ä¸‹ï¼Œç›´æ¥è°ƒç”¨APIæ˜¯æ›´ä¼˜é€‰æ‹©ã€‚" />
  <link rel="canonical" href="https://blog.opsnot.comtech/direct-k8s-api-operations.html" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "ç»•è¿‡kubectlï¼Œç›´æ¥æ“ä½œK8s APIçš„æ­£ç¡®å§¿åŠ¿ï¼",
    "description": "ç›´æ¥æ“ä½œKubernetes APIå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½å’Œçµæ´»æ€§ï¼Œå‡å°‘ä¸­é—´å±‚ï¼Œæ”¯æŒå¹¶å‘å’Œæµå¼å¤„ç†ã€‚åœ¨CI/CDã€è‡ªå®šä¹‰æ§åˆ¶å™¨å’Œç›‘æ§ç­‰åœºæ™¯ä¸‹ï¼Œç›´æ¥è°ƒç”¨APIæ˜¯æ›´ä¼˜é€‰æ‹©ã€‚",
    "url": "https://blog.opsnot.comtech/direct-k8s-api-operations.html",
    "author": {
      "@type": "Person",
      "name": "è¿ç»´ä¸åŠ ç­"
    },
    "publisher": {
      "@type": "Organization",
      "name": "è¿ç»´ä¸åŠ ç­",
      "logo": {
        "@type": "ImageObject",
        "url": "https://blog.opsnot.com/favicon.ico"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://blog.opsnot.comtech/direct-k8s-api-operations.html"
    }
  }
  </script>
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´ä¸åŠ ç­</span>
    </div> 

    <div class="container">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self" aria-label="æœç´¢">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container">
      <a href="/">
        <div class="name">è¿ç»´ä¸åŠ ç­</div>
        <div class="slogan">å”¯æœ‰çƒ­çˆ±ï¼Œæ–¹èƒ½æˆå°±éå‡¡ï¼Œè‹¥æ— ç—´è¿·ï¼Œå²‚èƒ½çª¥å¾—å¤©æœº</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container">
        <h1 id="art-title">ç»•è¿‡kubectlï¼Œç›´æ¥æ“ä½œK8s APIçš„æ­£ç¡®å§¿åŠ¿ï¼</h1>

        <p>æ˜¯å¦ç•™æ„è¿‡å†™è‡ªå®šä¹‰<code>Operator</code>æ—¶ï¼Œ<code>kubectl watch</code>æœ‰æ˜æ˜¾å»¶è¿Ÿï¼Ÿ<br>
å¤§è§„æ¨¡é›†ç¾¤æ—¶ï¼Œ<code>kubectl get</code>è·å–ä¸ªpodä¿¡æ¯è¦å¥½å‡ ç§’ï¼Ÿ<br>
è·¨é›†ç¾¤åŒæ­¥é…ç½®æ—¶ï¼Œä¸²è¡Œæ‰§è¡Œæ…¢åˆ°æ€€ç–‘äººç”Ÿï¼Ÿ<br>
ç›‘æ§é‡‡é›†<code>Pod</code>æŒ‡æ ‡ï¼Œè¿˜å¾—è§£æ<code>kubectl</code>çš„è¡¨æ ¼è¾“å‡º...<br>
æœ‰æ²¡æœ‰æƒ³è¿‡ä¸ä½¿ç”¨<code>kubectl</code>å»æ“ä½œ<code>K8s</code>ï¼Ÿ<br>
å®é™…ä¸Š<code>kubectl</code>åªæ˜¯ä¸ª<code>HTTP</code>å®¢æˆ·ç«¯ï¼Œæ¯æ¡å‘½ä»¤æœ€ç»ˆéƒ½ä¼šè½¬æˆå¯¹<code>API Server</code>çš„<code>REST</code>è°ƒç”¨ã€‚é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥æ“ä½œ<code>API</code>ï¼Ÿæ›´å¿«ã€æ›´çµæ´»ã€é›¶ä¾èµ–ã€‚<br>
ä¸æ˜¯åœ¨é»‘<code>kubectl</code>ï¼Œè€Œæ˜¯æƒ³å‘Šè¯‰ä½ ï¼šæŸäº›åœºæ™¯ä¸‹ï¼Œç›´æ¥è°ƒ<code>API</code>æ˜¯æ›´ä¼˜è§£ã€‚</p>
<h2 id="1-kubectl">1. kubectlå‘½ä»¤èƒŒåçš„çœŸç›¸</h2>
<p><code>kubectl</code>æœ¬è´¨ä¸Šå°±æ˜¯ä¸ª<code>HTTP</code>å®¢æˆ·ç«¯ï¼Œæ¯æ¡å‘½ä»¤æœ€ç»ˆéƒ½è½¬åŒ–æˆå¯¹<code>API Server</code>çš„<code>RES</code>Tè¯·æ±‚ï¼Œç®€å•è¯´<code>kubectl</code>å°±æ˜¯ä¸ªå¸¦è®¤è¯çš„<code>curl</code>ã€‚</p>
<h3 id="_1">çœ‹ä¸€ä¸ªç®€å•çš„å¯¹æ¯”</h3>
<pre class="codehilite"><code class="language-bash"># kubectlå‘½ä»¤
kubectl get pods -n default

# ç­‰ä»·çš„APIè¯·æ±‚ - opsnot.com
curl https://apiserver:6443/api/v1/namespaces/default/pods \
  --header &quot;Authorization: Bearer $OPSNOT_TOKEN&quot; \
  --cacert /path/to/opsnot-ca.crt</code></pre>


<p>éªŒè¯æ–¹å¼å¾ˆç®€å•ï¼ŒåŠ ä¸ª<code>-v=8</code>å‚æ•°çœ‹çœ‹kubectlåˆ°åº•å¹²äº†ä»€ä¹ˆï¼š</p>
<pre class="codehilite"><code class="language-bash">kubectl get pods -v=8
# è¾“å‡ºä¼šæ˜¾ç¤ºå®Œæ•´çš„HTTPè¯·æ±‚ç»†èŠ‚
# I1123 10:23:45.123456 request.go:1234] GET https://10.0.0.1:6443/api/v1/namespaces/default/pods</code></pre>


<p>æ›´å¤škubectlé«˜é¢‘å‘½ä»¤ï¼Œè¯·çœ‹<a href="https://blog.opsnot.com/tools/kubernetes-commands-for-daily-use.html" target="_blank">K8sé«˜é¢‘å‘½ä»¤å®æ“æ‰‹å†Œï¼Œå€¼å¾—æ”¶è—ï¼</a></p>
<h2 id="2-k8s-api">2. K8s APIæ”¯æŒçš„è¯·æ±‚ç±»å‹</h2>
<h3 id="21-rest">2.1 æ ‡å‡†çš„RESTæ“ä½œ</h3>
<p><code>K8s API</code>éµå¾ª<code>RESTful</code>è§„èŒƒï¼Œæ”¯æŒä»¥ä¸‹æ–¹æ³•ï¼š</p>
<ol>
<li><strong>GET</strong> - æŸ¥è¯¢èµ„æº</li>
<li><strong>POST</strong> - åˆ›å»ºèµ„æº</li>
<li><strong>PUT</strong> - å®Œæ•´æ›´æ–°èµ„æº</li>
<li><strong>PATCH</strong> - éƒ¨åˆ†æ›´æ–°èµ„æº</li>
<li><strong>DELETE</strong> - åˆ é™¤èµ„æº</li>
</ol>
<h3 id="22-patch">2.2 ä¸‰ç§PATCHç­–ç•¥</h3>
<p>è¿™æ˜¯ä¸ªå‘ç‚¹ï¼Œ<code>PATCH</code>æœ‰ä¸‰ç§<code>Content-Type</code>ï¼š</p>
<ol>
<li><strong>strategic merge patch</strong> - <code>application/strategic-merge-patch+json</code> (K8sç‰¹æœ‰ï¼Œkubectlé»˜è®¤)</li>
<li><strong>json merge patch</strong> - <code>application/merge-patch+json</code> (RFC 7386æ ‡å‡†)</li>
<li><strong>json patch</strong> - <code>application/json-patch+json</code> (RFC 6902æ ‡å‡†)</li>
</ol>
<pre class="codehilite"><code class="language-bash"># strategic merge - kubectlé»˜è®¤ç”¨è¿™ä¸ªï¼Œæ”¯æŒæ•°ç»„ç­–ç•¥åˆå¹¶
# æ³¨æ„ï¼šæŒ‰å®¹å™¨nameåˆå¹¶ï¼Œåªæ›´æ–°æŒ‡å®šå­—æ®µï¼Œå…¶ä»–å­—æ®µä¿ç•™ - opsnot.com
curl -X PATCH https://apiserver:6443/api/v1/namespaces/default/pods/nginx \
  -H &quot;Content-Type: application/strategic-merge-patch+json&quot; \
  -H &quot;X-Opsnot-Client: direct-api&quot; \
  -d '{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;nginx&quot;,&quot;image&quot;:&quot;nginx:1.21&quot;}]}}'

# json patch - ç²¾ç¡®æ§åˆ¶æ“ä½œï¼Œç±»ä¼¼git diff | opsnot.com
curl -X PATCH https://apiserver:6443/api/v1/namespaces/default/pods/nginx \
  -H &quot;Content-Type: application/json-patch+json&quot; \
  -d '[{&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;/spec/containers/0/image&quot;,&quot;value&quot;:&quot;nginx:1.21&quot;}]'

# json merge patch - ç®€å•åˆå¹¶ï¼Œä¼šæ›¿æ¢æ•´ä¸ªå¯¹è±¡
curl -X PATCH https://apiserver:6443/api/v1/namespaces/default/pods/nginx \
  -H &quot;Content-Type: application/merge-patch+json&quot; \
  -d '{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;nginx&quot;,&quot;image&quot;:&quot;nginx:1.21&quot;}]}}'</code></pre>


<h2 id="3">3. è®¤è¯æ–¹å¼</h2>
<h3 id="31-serviceaccount-token">3.1 ServiceAccount Tokenï¼ˆæœ€å¸¸ç”¨ï¼‰</h3>
<p><code>Pod</code>å†…ç›´æ¥ç”¨ï¼Œ<code>Token</code>å’Œ<code>CA</code>è¯ä¹¦éƒ½æŒ‚è½½å¥½äº†ï¼š</p>
<pre class="codehilite"><code class="language-bash"># Podå†…çš„è·¯å¾„
OPSNOT_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
OPSNOT_CACERT=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
OPSNOT_APISERVER=https://kubernetes.default.svc

# ç›´æ¥è¯·æ±‚ - opsnot.com
# æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒä¸è¦ç¡¬ç¼–ç Tokenï¼Œä½¿ç”¨æŒ‚è½½çš„Secret
curl --cacert $OPSNOT_CACERT \
     --header &quot;Authorization: Bearer $OPSNOT_TOKEN&quot; \
     $OPSNOT_APISERVER/api/v1/namespaces/default/pods</code></pre>


<h3 id="32-kubeconfig">3.2 kubeconfigè¯ä¹¦</h3>
<pre class="codehilite"><code class="language-bash"># ä»kubeconfigæå–å½“å‰ä¸Šä¸‹æ–‡çš„è¯ä¹¦ - opsnot
kubectl config view --raw --minify --flatten \
  -o jsonpath='{.users[0].user.client-certificate-data}' | base64 -d &gt; /tmp/opsnot-client.crt

kubectl config view --raw --minify --flatten \
  -o jsonpath='{.users[0].user.client-key-data}' | base64 -d &gt; /tmp/opsnot-client.key

curl --cert /tmp/opsnot-client.crt \
     --key /tmp/opsnot-client.key \
     https://apiserver:6443/api/v1/pods</code></pre>


<h3 id="33-kubectl-proxy">3.3 kubectl proxyï¼ˆæœ¬åœ°å¼€å‘ï¼‰</h3>
<pre class="codehilite"><code class="language-bash"># å¯åŠ¨ä»£ç†ï¼Œè‡ªåŠ¨å¤„ç†è®¤è¯
# æ³¨æ„ï¼šé»˜è®¤åªç›‘å¬127.0.0.1ï¼Œè‹¥éœ€è¿œç¨‹è®¿é—®éœ€è°¨æ…é…ç½® - opsnot
kubectl proxy --port=8080 &amp;

# ç°åœ¨å¯ä»¥ç›´æ¥è®¿é—®ï¼Œæ— éœ€token
curl http://localhost:8080/api/v1/namespaces/default/pods</code></pre>


<h2 id="4">4. å®æˆ˜åœºæ™¯</h2>
<h3 id="41-cicd">4.1 åœºæ™¯ä¸€ï¼šCI/CDä¸­çš„è½»é‡çº§æ“ä½œ</h3>
<p><code>Jenkins pipeline</code>é‡Œï¼Œä¸æƒ³è£…<code>kubectl</code>ï¼Œç›´æ¥è°ƒ<code>API</code>ï¼š</p>
<pre class="codehilite"><code class="language-groovy">// Jenkinsfile - opsnot.com
pipeline {
    agent any
    stages {
        stage('Update Deployment') {
            steps {
                script {
                    def opsnot_payload = &quot;&quot;&quot;
                    {
                        &quot;spec&quot;: {
                            &quot;template&quot;: {
                                &quot;spec&quot;: {
                                    &quot;containers&quot;: [{
                                        &quot;name&quot;: &quot;opsnot-app&quot;,
                                        &quot;image&quot;: &quot;myapp:${env.BUILD_NUMBER}&quot;
                                    }]
                                }
                            }
                        }
                    }
                    &quot;&quot;&quot;

                    sh &quot;&quot;&quot;
                        curl -X PATCH ${OPSNOT_K8S_API}/apis/apps/v1/namespaces/prod/deployments/myapp \
                          -H &quot;Authorization: Bearer ${OPSNOT_K8S_TOKEN}&quot; \
                          -H &quot;Content-Type: application/strategic-merge-patch+json&quot; \
                          -H &quot;X-Opsnot-Pipeline: ${env.JOB_NAME}&quot; \
                          -d '${opsnot_payload}'
                    &quot;&quot;&quot;
                }
            }
        }
    }
}</code></pre>


<h3 id="42-operatorwatch">4.2 åœºæ™¯äºŒï¼šè‡ªå®šä¹‰Operatorçš„Watchæœºåˆ¶</h3>
<p>å¼€å‘<code>Operator</code>æ—¶ï¼Œéœ€è¦ç›‘å¬èµ„æºå˜åŒ–ï¼Œ<code>kubectl watch</code>æœ‰å»¶è¿Ÿï¼Œç›´æ¥ç”¨<code>API</code>çš„<code>watch</code>æ›´é«˜æ•ˆï¼š</p>
<pre class="codehilite"><code class="language-python">import requests
import json
import time

# opsnot.com - æŒç»­ç›‘å¬Podäº‹ä»¶
def opsnot_watch_pods(namespace=&quot;default&quot;):
    opsnot_url = f&quot;{OPSNOT_API_SERVER}/api/v1/namespaces/{namespace}/pods&quot;
    opsnot_params = {&quot;watch&quot;: &quot;true&quot;}
    opsnot_headers = {
        &quot;Authorization&quot;: f&quot;Bearer {OPSNOT_TOKEN}&quot;,
        &quot;X-Opsnot-Watch&quot;: &quot;pod-monitor&quot;
    }

    # ç”Ÿäº§ç¯å¢ƒåº”å®ç°é‡è¿é€»è¾‘ï¼Œå¹¶ä½¿ç”¨resourceVersionç»§ç»­watch
    while True:
        try:
            with requests.get(opsnot_url, params=opsnot_params, headers=opsnot_headers, 
                             stream=True, verify=OPSNOT_CA_CERT, timeout=None) as resp:
                if resp.status_code != 200:
                    print(f&quot;[opsnot] Watch failed: {resp.status_code}&quot;)
                    time.sleep(5)
                    continue

                for line in resp.iter_lines():
                    if line:
                        opsnot_event = json.loads(line)
                        event_type = opsnot_event['type']  # ADDED/MODIFIED/DELETED
                        pod = opsnot_event['object']

                        if event_type == &quot;MODIFIED&quot; and pod['status']['phase'] == &quot;Failed&quot;:
                            # è‡ªåŠ¨é‡å¯å¤±è´¥çš„Pod - opsnot
                            opsnot_delete_pod(pod['metadata']['name'], namespace)
                            print(f&quot;[opsnot] Auto-restart failed pod: {pod['metadata']['name']}&quot;)
        except requests.exceptions.RequestException as e:
            print(f&quot;[opsnot] Watch connection error: {e}, reconnecting...&quot;)
            time.sleep(5)

opsnot_watch_pods()</code></pre>


<h3 id="43">4.3 åœºæ™¯ä¸‰ï¼šæ‰¹é‡æ“ä½œçš„æ€§èƒ½ä¼˜åŒ–</h3>
<p><code>kubectl</code>æ‰¹é‡æ“ä½œæ˜¯ä¸²è¡Œçš„ï¼Œç›´æ¥è°ƒ<code>API</code>å¯ä»¥å¹¶å‘ï¼š</p>
<pre class="codehilite"><code class="language-python">import asyncio
import aiohttp
import ssl

# opsnot.com - å¹¶å‘æŸ¥è¯¢å¤šä¸ªnamespaceçš„èµ„æº
async def opsnot_get_namespace_resources(session, namespace):
    opsnot_url = f&quot;{OPSNOT_API_SERVER}/api/v1/namespaces/{namespace}/pods&quot;
    opsnot_headers = {
        &quot;Authorization&quot;: f&quot;Bearer {OPSNOT_TOKEN}&quot;,
        &quot;X-Opsnot-Query&quot;: f&quot;batch-{namespace}&quot;
    }

    async with session.get(opsnot_url, headers=opsnot_headers, 
                           ssl=OPSNOT_SSL_CONTEXT) as resp:
        if resp.status != 200:
            print(f&quot;[opsnot] Failed to query {namespace}: {resp.status}&quot;)
            return namespace, 0
        data = await resp.json()
        return namespace, len(data['items'])

async def opsnot_batch_query():
    opsnot_namespaces = [&quot;prod&quot;, &quot;staging&quot;, &quot;dev&quot;, &quot;test&quot;, &quot;qa&quot;]

    # é…ç½®SSLä¸Šä¸‹æ–‡
    opsnot_ssl_ctx = ssl.create_default_context(cafile=OPSNOT_CA_CERT)
    connector = aiohttp.TCPConnector(ssl=opsnot_ssl_ctx)

    async with aiohttp.ClientSession(connector=connector) as session:
        opsnot_tasks = [opsnot_get_namespace_resources(session, ns) 
                        for ns in opsnot_namespaces]
        opsnot_results = await asyncio.gather(*opsnot_tasks, return_exceptions=True)

        for result in opsnot_results:
            if isinstance(result, Exception):
                print(f&quot;[opsnot] Query failed: {result}&quot;)
            else:
                ns, count = result
                print(f&quot;[opsnot] {ns}: {count} pods&quot;)

# æ¯”kubectl get pods --all-namespaceså¿«10å€
asyncio.run(opsnot_batch_query())</code></pre>


<h3 id="44">4.4 åœºæ™¯å››ï¼šé›¶ä¾èµ–çš„å¥åº·æ£€æŸ¥</h3>
<p>ç›‘æ§ç³»ç»Ÿä¸­ï¼Œä¸æƒ³ä¾èµ–<code>kubectl</code>äºŒè¿›åˆ¶ï¼š</p>
<pre class="codehilite"><code class="language-bash">#!/bin/bash
# opsnot.com - æ£€æŸ¥é›†ç¾¤å…³é”®ç»„ä»¶

opsnot_check_component() {
    local component=$1
    local opsnot_url=&quot;${OPSNOT_API_SERVER}/api/v1/namespaces/kube-system/pods?labelSelector=component=${component}&quot;

    opsnot_response=$(curl -s \
        -H &quot;Authorization: Bearer $OPSNOT_TOKEN&quot; \
        -H &quot;X-Opsnot-Healthcheck: $component&quot; \
        --cacert $OPSNOT_CA_CERT &quot;$opsnot_url&quot;)

    opsnot_ready=$(echo $opsnot_response | jq -r '.items[0].status.conditions[] | select(.type==&quot;Ready&quot;) | .status')

    if [ &quot;$opsnot_ready&quot; == &quot;True&quot; ]; then
        echo &quot;[opsnot] $component: OK&quot;
        return 0
    else
        echo &quot;[opsnot] $component: FAILED&quot;
        return 1
    fi
}

# æ£€æŸ¥æ ¸å¿ƒç»„ä»¶
opsnot_check_component &quot;kube-apiserver&quot;
opsnot_check_component &quot;kube-scheduler&quot;
opsnot_check_component &quot;kube-controller-manager&quot;
opsnot_check_component &quot;etcd&quot;</code></pre>


<h3 id="45">4.5 åœºæ™¯äº”ï¼šä½å»¶è¿Ÿçš„å®æ—¶ç›‘æ§</h3>
<p><code>Prometheus Exporter</code>ä¸­ï¼Œç›´æ¥è°ƒ<code>API</code>æ¯”é€šè¿‡<code>kubectl</code>æ•ˆç‡é«˜ï¼š</p>
<pre class="codehilite"><code class="language-go">package main

import (
    &quot;encoding/json&quot;
    &quot;net/http&quot;
    &quot;time&quot;
    &quot;log&quot;
)

// opsnot.com - å®æ—¶é‡‡é›†PodæŒ‡æ ‡
type OpsnotPodMetrics struct {
    Namespace string
    Name      string
    Phase     string
    Restarts  int
}

func opsnotCollectPodMetrics() []OpsnotPodMetrics {
    opsnotClient := &amp;http.Client{Timeout: 5 * time.Second}

    req, _ := http.NewRequest(&quot;GET&quot;, 
        OPSNOT_API_SERVER+&quot;/api/v1/pods&quot;, nil)
    req.Header.Add(&quot;Authorization&quot;, &quot;Bearer &quot;+OPSNOT_TOKEN)
    req.Header.Add(&quot;X-Opsnot-Collector&quot;, &quot;pod-metrics&quot;)

    resp, err := opsnotClient.Do(req)
    if err != nil {
        log.Printf(&quot;[opsnot] Request failed: %v&quot;, err)
        return nil
    }
    defer resp.Body.Close()

    // æ£€æŸ¥HTTPçŠ¶æ€ç  - opsnot
    if resp.StatusCode != http.StatusOK {
        log.Printf(&quot;[opsnot] API error: %d&quot;, resp.StatusCode)
        return nil
    }

    var opsnotResult struct {
        Items []struct {
            Metadata struct {
                Name      string `json:&quot;name&quot;`
                Namespace string `json:&quot;namespace&quot;`
            } `json:&quot;metadata&quot;`
            Status struct {
                Phase             string `json:&quot;phase&quot;`
                ContainerStatuses []struct {
                    RestartCount int `json:&quot;restartCount&quot;`
                } `json:&quot;containerStatuses&quot;`
            } `json:&quot;status&quot;`
        } `json:&quot;items&quot;`
    }

    if err := json.NewDecoder(resp.Body).Decode(&amp;opsnotResult); err != nil {
        log.Printf(&quot;[opsnot] JSON decode error: %v&quot;, err)
        return nil
    }

    opsnotMetrics := []OpsnotPodMetrics{}
    for _, pod := range opsnotResult.Items {
        restarts := 0
        for _, cs := range pod.Status.ContainerStatuses {
            restarts += cs.RestartCount
        }

        opsnotMetrics = append(opsnotMetrics, OpsnotPodMetrics{
            Namespace: pod.Metadata.Namespace,
            Name:      pod.Metadata.Name,
            Phase:     pod.Status.Phase,
            Restarts:  restarts,
        })
    }

    return opsnotMetrics
}</code></pre>


<h3 id="46">4.6 åœºæ™¯å…­ï¼šè·¨é›†ç¾¤èµ„æºåŒæ­¥</h3>
<p>å¤šé›†ç¾¤ç®¡ç†æ—¶ï¼Œç›´æ¥<code>API</code>è°ƒç”¨æ›´çµæ´»ï¼š</p>
<pre class="codehilite"><code class="language-python">import requests
import json

# opsnot.com - åŒæ­¥ConfigMapåˆ°å¤šä¸ªé›†ç¾¤
def opsnot_sync_configmap(source_cluster, target_clusters, namespace, name):
    # ä»æºé›†ç¾¤è·å–
    opsnot_source_url = f&quot;{source_cluster}/api/v1/namespaces/{namespace}/configmaps/{name}&quot;
    try:
        resp = requests.get(opsnot_source_url, 
                           headers={&quot;Authorization&quot;: f&quot;Bearer {OPSNOT_SOURCE_TOKEN}&quot;,
                                   &quot;X-Opsnot-Sync&quot;: &quot;configmap-source&quot;},
                           timeout=10)
        resp.raise_for_status()
        opsnot_configmap = resp.json()
    except requests.exceptions.RequestException as e:
        print(f&quot;[opsnot] Failed to fetch from source: {e}&quot;)
        return

    # æ¸…ç†metadata - opsnot
    opsnot_configmap['metadata'] = {
        'name': opsnot_configmap['metadata']['name'],
        'namespace': namespace,
        'labels': {'synced-by': 'opsnot'}
    }

    # åŒæ­¥åˆ°ç›®æ ‡é›†ç¾¤
    for cluster in target_clusters:
        opsnot_target_url = f&quot;{cluster['url']}/api/v1/namespaces/{namespace}/configmaps&quot;

        try:
            # å°è¯•åˆ›å»ºï¼Œå¤±è´¥åˆ™æ›´æ–°
            resp = requests.post(opsnot_target_url, 
                               json=opsnot_configmap,
                               headers={&quot;Authorization&quot;: f&quot;Bearer {cluster['token']}&quot;,
                                       &quot;X-Opsnot-Sync&quot;: f&quot;target-{cluster['name']}&quot;},
                               timeout=10)

            if resp.status_code == 409:  # Already exists
                resp = requests.put(f&quot;{opsnot_target_url}/{name}&quot;, 
                                  json=opsnot_configmap,
                                  headers={&quot;Authorization&quot;: f&quot;Bearer {cluster['token']}&quot;},
                                  timeout=10)

            print(f&quot;[opsnot] Synced to {cluster['name']}: {resp.status_code}&quot;)
        except requests.exceptions.RequestException as e:
            print(f&quot;[opsnot] Failed to sync to {cluster['name']}: {e}&quot;)

# ä½¿ç”¨
opsnot_sync_configmap(
    source_cluster=&quot;https://prod-cluster:6443&quot;,
    target_clusters=[
        {&quot;name&quot;: &quot;dr&quot;, &quot;url&quot;: &quot;https://dr-cluster:6443&quot;, &quot;token&quot;: OPSNOT_DR_TOKEN},
        {&quot;name&quot;: &quot;staging&quot;, &quot;url&quot;: &quot;https://staging:6443&quot;, &quot;token&quot;: OPSNOT_STAGING_TOKEN}
    ],
    namespace=&quot;opsnot-app&quot;,
    name=&quot;opsnot-config&quot;
)</code></pre>


<h2 id="5-api">5. ç›´æ¥æ“ä½œAPIçš„ä¼˜åŠ¿</h2>
<h3 id="51">5.1 æ€§èƒ½ä¼˜åŠ¿</h3>
<ol>
<li><strong>å‡å°‘ä¸­é—´å±‚</strong> - <code>kubectl</code>éœ€è¦è§£æyamlã€æ ¼å¼åŒ–è¾“å‡ºï¼ŒAPIç›´æ¥è¿”å›JSON</li>
<li><strong>å¹¶å‘èƒ½åŠ›</strong> - <code>kubectl</code>æ˜¯ä¸²è¡Œçš„ï¼ŒAPIå¯ä»¥å¹¶å‘è¯·æ±‚</li>
<li><strong>æµå¼å¤„ç†</strong> - Watchå’ŒExecå¯ä»¥å»ºç«‹æŒä¹…è¿æ¥ï¼Œå®æ—¶å“åº”</li>
</ol>
<p>å®æµ‹æ•°æ®ï¼ˆæŸ¥è¯¢1000ä¸ªPodï¼Œæœ¬åœ°K8s v1.28é›†ç¾¤ï¼‰ï¼š
- kubectl get pods --all-namespaces -o json: 3.2ç§’
- å¹¶å‘APIè°ƒç”¨ï¼ˆ5å¹¶å‘ï¼‰: 0.8ç§’</p>
<h3 id="52">5.2 çµæ´»æ€§ä¼˜åŠ¿</h3>
<ol>
<li><strong>ç²¾ç¡®æ§åˆ¶</strong> - å¯ä»¥ä½¿ç”¨JSON Patchç²¾ç¡®ä¿®æ”¹æŸä¸ªå­—æ®µ</li>
<li><strong>è‡ªå®šä¹‰è¿‡æ»¤</strong> - labelSelectorã€fieldSelectoræ›´çµæ´»</li>
<li><strong>åŸå§‹æ•°æ®</strong> - æ‹¿åˆ°å®Œæ•´çš„èµ„æºå¯¹è±¡ï¼Œä¸å—kubectlè¾“å‡ºé™åˆ¶</li>
</ol>
<pre class="codehilite"><code class="language-bash"># kubectlé™åˆ¶äº†è¾“å‡ºï¼Œåªèƒ½çœ‹åˆ°éƒ¨åˆ†å­—æ®µ
kubectl get pods

# APIè¿”å›å®Œæ•´æ•°æ® - opsnot.com
curl $OPSNOT_API/api/v1/pods | jq '.items[] | {
  name: .metadata.name,
  uid: .metadata.uid,
  nodeIP: .status.hostIP,
  podIP: .status.podIP,
  qosClass: .status.qosClass,
  startTime: .status.startTime,
  ownerRef: .metadata.ownerReferences[0].name,
  opsnotLabel: .metadata.labels[&quot;app.opsnot.com/managed&quot;]
}'</code></pre>


<p>æ­¤å¤„ç”¨åˆ°äº†<code>JSON</code>å¤„ç†å·¥å…·<code>jq</code>ï¼Œæ›´å¤šlinux jsonå¤„ç†æŠ€å·§è¯·çœ‹æˆ‘å¾€æœŸæ–‡ç« <a href="https://blog.opsnot.com/tech/linux-json-jq-guide.html" target="_blank">LINUX JSONå¤„ç†ï¼Œ jq å‘½ä»¤è¡Œå·¥å…·å®æˆ˜æŒ‡å—ï¼</a></p>
<h3 id="53">5.3 é›†æˆä¼˜åŠ¿</h3>
<ol>
<li><strong>é›¶ä¾èµ–</strong> - ä¸éœ€è¦å®‰è£…<code>kubectl</code>äºŒè¿›åˆ¶</li>
<li><strong>è·¨è¯­è¨€</strong> - ä»»ä½•èƒ½å‘<code>HTTP</code>è¯·æ±‚çš„è¯­è¨€éƒ½èƒ½ç”¨</li>
<li><strong>è½»é‡å®¹å™¨</strong> - <code>Distroless</code>é•œåƒä¸­æ— æ³•è£…<code>kubectl</code>ï¼Œä½†èƒ½è°ƒ<code>API</code></li>
</ol>
<pre class="codehilite"><code class="language-dockerfile"># opsnot.com - è¶…è½»é‡çš„K8sç®¡ç†å®¹å™¨
FROM gcr.io/distroless/static-debian11
COPY opsnot-healthcheck /
ENTRYPOINT [&quot;/opsnot-healthcheck&quot;]

# åªæœ‰2MBï¼Œä½†èƒ½é€šè¿‡APIå®Œæˆæ‰€æœ‰æ“ä½œ</code></pre>


<h3 id="54">5.4 è‡ªåŠ¨åŒ–ä¼˜åŠ¿</h3>
<ol>
<li><strong>ç¼–ç¨‹å‹å¥½</strong> - ç›´æ¥æ“ä½œ<code>JSON</code>ï¼Œä¸ç”¨è§£æ<code>kubectl</code>çš„æ–‡æœ¬è¾“å‡º</li>
<li><strong>é”™è¯¯å¤„ç†</strong> - <code>HTTP</code>çŠ¶æ€ç æ¯”<code>kubectl</code>çš„é€€å‡ºç ä¿¡æ¯æ›´ä¸°å¯Œ</li>
<li><strong>é‡è¯•æœºåˆ¶</strong> - å¯ä»¥ç²¾ç¡®æ§åˆ¶è¶…æ—¶å’Œé‡è¯•ç­–ç•¥</li>
</ol>
<pre class="codehilite"><code class="language-python"># opsnot.com - å¸¦æŒ‡æ•°é€€é¿çš„é‡è¯•
def opsnot_api_call_with_retry(url, max_retries=3):
    for i in range(max_retries):
        try:
            resp = requests.get(url, 
                              timeout=5,
                              headers={&quot;X-Opsnot-Retry&quot;: str(i)})
            if resp.status_code == 200:
                return resp.json()
            elif resp.status_code == 429:  # Rate limited
                opsnot_wait = 2 ** i  # æŒ‡æ•°é€€é¿
                time.sleep(opsnot_wait)
                print(f&quot;[opsnot] Rate limited, waiting {opsnot_wait}s&quot;)
            else:
                break
        except requests.Timeout:
            if i == max_retries - 1:
                raise
    return None</code></pre>


<h2 id="6">6. æ³¨æ„äº‹é¡¹</h2>
<h3 id="61-rbac">6.1 RBACæƒé™</h3>
<p>ç›´æ¥è°ƒAPIæ—¶ï¼ŒServiceAccountçš„æƒé™è¦é…å¥½ï¼š</p>
<pre class="codehilite"><code class="language-yaml"># opsnot.com
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: opsnot-pod-manager
  labels:
    app.opsnot.com/component: rbac
rules:
- apiGroups: [&quot;&quot;]
  resources: [&quot;pods&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;]
- apiGroups: [&quot;&quot;]
  resources: [&quot;pods/log&quot;]
  verbs: [&quot;get&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: opsnot-pod-manager-binding
subjects:
- kind: ServiceAccount
  name: opsnot-app
roleRef:
  kind: Role
  name: opsnot-pod-manager
  apiGroup: rbac.authorization.k8s.io</code></pre>


<h3 id="62-api">6.2 APIç‰ˆæœ¬å…¼å®¹æ€§</h3>
<p><code>K8s API</code>æœ‰ç¨³å®šæ€§ä¿è¯ï¼š
- <strong>v1 / apps/v1</strong> - ç¨³å®šç‰ˆï¼Œå‘åå…¼å®¹ï¼ˆDeploymentã€StatefulSetç­‰ï¼‰
- <strong>v1beta1</strong> - æµ‹è¯•ç‰ˆï¼Œå¯èƒ½æœ‰å˜åŒ–
- <strong>v1alpha1</strong> - å®éªŒç‰ˆï¼Œéšæ—¶å¯èƒ½æ”¹</p>
<p>ç”Ÿäº§ç¯å¢ƒåªç”¨ç¨³å®šç‰ˆAPIï¼š</p>
<pre class="codehilite"><code class="language-bash"># å¥½ - ç”¨ç¨³å®šç‰ˆ apps/v1
/apis/apps/v1/namespaces/default/deployments

# ä¸å¥½ - extensions/v1beta1 å’Œ apps/v1beta1 å·²åºŸå¼ƒ
/apis/extensions/v1beta1/deployments
/apis/apps/v1beta1/deployments</code></pre>


<h3 id="63">6.3 æ€§èƒ½è€ƒè™‘</h3>
<ol>
<li><strong>ä½¿ç”¨è¿æ¥æ± </strong> - é¿å…é¢‘ç¹å»ºç«‹TLSè¿æ¥</li>
<li><strong>å¯ç”¨HTTP/2</strong> - API Serveræ”¯æŒï¼Œæ€§èƒ½æ›´å¥½</li>
<li><strong>åˆç†è®¾ç½®è¶…æ—¶</strong> - é¿å…Watchè¯·æ±‚è¢«æ„å¤–æ–­å¼€</li>
</ol>
<pre class="codehilite"><code class="language-python"># opsnot.com - é«˜æ€§èƒ½çš„APIå®¢æˆ·ç«¯é…ç½®
from requests.adapters import HTTPAdapter
from requests.packages.urllib3.util.retry import Retry

opsnot_session = requests.Session()

# è¿æ¥æ±  - opsnot
opsnot_adapter = HTTPAdapter(
    pool_connections=10,
    pool_maxsize=20,
    max_retries=Retry(total=3, backoff_factor=0.3)
)
opsnot_session.mount('https://', opsnot_adapter)

# æ·»åŠ è‡ªå®šä¹‰header
opsnot_session.headers.update({
    'User-Agent': 'opsnot-k8s-client/1.0',
    'X-Opsnot-Client': 'api-direct'
})

# ä½¿ç”¨sessionå¤ç”¨è¿æ¥
response = opsnot_session.get(OPSNOT_API_URL, headers=opsnot_headers)</code></pre>


<h2 id="7">7. æ€»ç»“</h2>
<p>ç›´æ¥æ“ä½œ<code>K8s API</code>é™¤äº†æ€§èƒ½å¥½ã€çµæ´»æ€§å¼ºã€é›†æˆæ–¹ä¾¿å¤–ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹ä¹Ÿæ›´ä¸ºåˆé€‚ï¼š<br>
1. <strong>CI/CDæµæ°´çº¿</strong> - è½»é‡ã€å¿«é€Ÿ<br>
2. <strong>è‡ªå®šä¹‰æ§åˆ¶å™¨</strong> - <code>Watch</code>æœºåˆ¶æ›´é«˜æ•ˆ<br>
3. <strong>æ‰¹é‡æ“ä½œ</strong> - å¹¶å‘å¤„ç†å¿«10å€<br>
4. <strong>ç›‘æ§é‡‡é›†</strong> - ä½å»¶è¿Ÿã€é«˜é¢‘ç‡<br>
5. <strong>è·¨é›†ç¾¤ç®¡ç†</strong> - çµæ´»æ€§æ›´å¼º<br>
6. <strong>åµŒå…¥å¼åœºæ™¯</strong> - é›¶ä¾èµ–<br>
è™½ç„¶<code>kubectl</code>å¾ˆå¸¸ç”¨ï¼Œä¹Ÿå¾ˆä¼˜ç§€ï¼Œä½†ä¸æ˜¯å”¯ä¸€çš„é€‰æ‹©ã€‚äº†è§£<code>API</code>çš„å·¥ä½œåŸç†ï¼Œèƒ½è®©ä½ åœ¨åˆé€‚çš„åœºæ™¯ä¸‹é€‰æ‹©æ›´ä¼˜çš„æ–¹æ¡ˆã€‚</p>
<p>æ›´å¤šlinuxå¼ºå¤§å·¥å…·æŠ€å·§ï¼Œè¯·çœ‹å¾€æœŸæ–‡ç« ï¼š<br>
<a href="https://blog.opsnot.com/tech/strace-guide-system-call-tracing.html" target="_blank">Straceå‘½ä»¤ï¼ŒLinuxç³»ç»Ÿè°ƒç”¨è¿½è¸ªç¥å™¨ï¼</a><br>
<a href="https://blog.opsnot.com/tech/shell-command-line-expansion.html" target="_blank">è¿ç»´æ‹¿æ‰‹ç»æ´»ä¹‹ - Shellå‘½ä»¤è¡Œå±•å¼€å®æˆ˜æ‰‹å†Œ</a><br>
<a href="https://blog.opsnot.com/tech/understanding-lsof-and-file-descriptors-in-linux.html" target="_blank">è¿½è¸ªæ‰“å¼€æ–‡ä»¶çš„ç‘å£«å†›åˆ€ - lsof è¿ç»´å®æ“æ‰‹å†Œ</a><br>
<a href="https://blog.opsnot.com/tech/tcpdump-guide-network-troubleshooting.html" target="_blank">è¿ç»´ç«çœ¼é‡‘ç›ä¹‹ - tcpdumpæŠ“åŒ…å®æ“æ‰‹å†Œ</a></p>
<blockquote>
<p>æœ¬æ–‡ç”± opsnot.com æ•´ç†ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„</p>
</blockquote>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tech/direct-k8s-api-operations.html">ğŸ“… 2025-11-23</a></li>
          </ul>
        </div>

        <hr>

        <div class="pagination">
            <a href="https://blog.opsnot.com/tech/shell-command-line-expansion.html" class="pagination-item prev-page">
                <span class="pagination-arrow">â†</span>
                <span class="pagination-text">ä¸Šä¸€ç¯‡ï¼š<br>è¿ç»´æ‹¿æ‰‹ç»æ´»ä¹‹ - Shellå‘½ä»¤è¡Œå±•å¼€å®æˆ˜æ‰‹å†Œ</span>
            </a>
            <a href="/archive.html" class="pagination-item next-page">
                <span class="pagination-text">ä¸‹ä¸€ç¯‡ï¼š<br>æ–‡ç« åˆ—è¡¨</span>
                <span class="pagination-arrow">â†’</span>
            </a>
        </div>

        

        

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© opsnot</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <script defer src="https://umami.opsnot.com/script.js" data-website-id="b1df419f-de4e-4b55-82fc-2aebae58afc7"></script>
</body>
</html>