<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="Ansibleæ¦‚è§ˆ, è‡ªåŠ¨åŒ–è¿ç»´, Ansibleä¼˜åŠ¿, Ansibleå®‰è£…, SSHå…å¯†é…ç½®, Ansibleç›®å½•ç»“æ„, Ansible Playbook, Ansible Role, Ansibleæ€§èƒ½ä¼˜åŒ–, Ansibleå®‰å…¨åŠ å›º, Ansibleè°ƒè¯•" />
  <meta name="description" content="æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†Ansibleçš„ä¸‰å¤§ä¼˜åŠ¿ã€æ ¸å¿ƒç»„ä»¶ã€å®‰è£…é…ç½®ã€SSHå…å¯†é…ç½®ã€æ ‡å‡†ç›®å½•ç»“æ„ã€Playbookè¯­æ³•ã€Roleè§’è‰²åŒ–ç®¡ç†åŠæ€§èƒ½ä¼˜åŒ–ç­‰ï¼Œå¸®åŠ©ä½ æŒæ¡Ansibleè‡ªåŠ¨åŒ–è¿ç»´çš„æœ€ä½³å®è·µã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´ä¸åŠ ç­" href="https://blog.opsnot.com/feed.xml" />
  <link rel="stylesheet" href="https://blog.opsnot.com/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>è¿ç»´è‡ªåŠ¨åŒ–åˆ©å™¨ä¹‹ - Ansibleå®æˆ˜æŒ‡å—</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´ä¸åŠ ç­" />
  <meta property="og:url" content="https://blog.opsnot.comtech/ansible-overview-and-best-practices.html" />
  <meta property="og:title" content="è¿ç»´è‡ªåŠ¨åŒ–åˆ©å™¨ä¹‹ - Ansibleå®æˆ˜æŒ‡å—" />
  <meta property="og:description" content="æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†Ansibleçš„ä¸‰å¤§ä¼˜åŠ¿ã€æ ¸å¿ƒç»„ä»¶ã€å®‰è£…é…ç½®ã€SSHå…å¯†é…ç½®ã€æ ‡å‡†ç›®å½•ç»“æ„ã€Playbookè¯­æ³•ã€Roleè§’è‰²åŒ–ç®¡ç†åŠæ€§èƒ½ä¼˜åŒ–ç­‰ï¼Œå¸®åŠ©ä½ æŒæ¡Ansibleè‡ªåŠ¨åŒ–è¿ç»´çš„æœ€ä½³å®è·µã€‚" />
  <link rel="canonical" href="https://blog.opsnot.comtech/ansible-overview-and-best-practices.html" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "è¿ç»´è‡ªåŠ¨åŒ–åˆ©å™¨ä¹‹ - Ansibleå®æˆ˜æŒ‡å—",
    "description": "æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†Ansibleçš„ä¸‰å¤§ä¼˜åŠ¿ã€æ ¸å¿ƒç»„ä»¶ã€å®‰è£…é…ç½®ã€SSHå…å¯†é…ç½®ã€æ ‡å‡†ç›®å½•ç»“æ„ã€Playbookè¯­æ³•ã€Roleè§’è‰²åŒ–ç®¡ç†åŠæ€§èƒ½ä¼˜åŒ–ç­‰ï¼Œå¸®åŠ©ä½ æŒæ¡Ansibleè‡ªåŠ¨åŒ–è¿ç»´çš„æœ€ä½³å®è·µã€‚",
    "url": "https://blog.opsnot.comtech/ansible-overview-and-best-practices.html",
    "author": {
      "@type": "Person",
      "name": "è¿ç»´ä¸åŠ ç­"
    },
    "publisher": {
      "@type": "Organization",
      "name": "è¿ç»´ä¸åŠ ç­",
      "logo": {
        "@type": "ImageObject",
        "url": "https://blog.opsnot.com/favicon.ico"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://blog.opsnot.comtech/ansible-overview-and-best-practices.html"
    }
  }
  </script>
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´ä¸åŠ ç­</span>
    </div> 

    <div class="container">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self" aria-label="æœç´¢">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container">
      <a href="/">
        <div class="name">è¿ç»´ä¸åŠ ç­</div>
        <div class="slogan">å”¯æœ‰çƒ­çˆ±ï¼Œæ–¹èƒ½æˆå°±éå‡¡ï¼Œè‹¥æ— ç—´è¿·ï¼Œå²‚èƒ½çª¥å¾—å¤©æœº</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container">
        <h1 id="art-title">è¿ç»´è‡ªåŠ¨åŒ–åˆ©å™¨ä¹‹ - Ansibleå®æˆ˜æŒ‡å—</h1>

        <h2 id="1-ansible">1. Ansibleæ¦‚è§ˆ</h2>
<h3 id="11">1.1 ä¸‰å¤§ä¼˜åŠ¿</h3>
<p><strong>æ— Agentæ¶æ„</strong>ï¼šåªä¾èµ–SSHå’ŒPythonï¼Œä¸éœ€è¦åœ¨ç›®æ ‡æœºå™¨ä¸Šå®‰è£…å®¢æˆ·ç«¯ã€‚ç®¡ç†ä¸Šåƒå°æœåŠ¡å™¨æ—¶ï¼Œè¿™ä¸ªä¼˜åŠ¿éå¸¸æ˜æ˜¾ã€‚</p>
<p><strong>å¹‚ç­‰æ€§ä¿éšœ</strong>ï¼šé‡å¤æ‰§è¡ŒåŒä¸€ä¸ªplaybookï¼Œç»“æœå§‹ç»ˆä¸€è‡´ã€‚ç”Ÿäº§ç¯å¢ƒå›æ»šã€é‡æ–°éƒ¨ç½²æ—¶éå¸¸å…³é”®ã€‚</p>
<p><strong>YAMLå¯è¯»æ€§</strong>ï¼šå£°æ˜å¼è¯­æ³•è®©è¿ç»´æ–‡æ¡£å’Œä»£ç åˆäºŒä¸ºä¸€ï¼Œæ¯”Shellè„šæœ¬æ¸…æ™°å¤ªå¤šã€‚</p>
<h3 id="12">1.2 æ ¸å¿ƒç»„ä»¶</h3>
<ul>
<li><strong>Inventory</strong>ï¼šå®šä¹‰ç®¡ç†å“ªäº›æœºå™¨</li>
<li><strong>Playbook</strong>ï¼šæè¿°è‡ªåŠ¨åŒ–ä»»åŠ¡  </li>
<li><strong>Module</strong>ï¼šæ‰§è¡Œå…·ä½“æ“ä½œ</li>
<li><strong>Role</strong>ï¼šç»„ç»‡å’Œå¤ç”¨ä»£ç </li>
</ul>
<h2 id="2">2. ç¯å¢ƒå‡†å¤‡ä¸ç›®å½•ç»“æ„</h2>
<h3 id="21">2.1 å®‰è£…é…ç½®</h3>
<pre class="codehilite"><code class="language-bash"># CentOS/RHEL (éœ€å¯ç”¨EPELæº)
yum install epel-release -y
yum install -y ansible

# Ubuntu/Debian (éœ€å¯ç”¨Universeæº)
apt update &amp;&amp; apt install -y ansible

# æˆ–ä½¿ç”¨pipå®‰è£…æœ€æ–°ç‰ˆ - opsnot
pip3 install ansible

# éªŒè¯å®‰è£…
ansible --version</code></pre>


<h3 id="22-ssh">2.2 SSHå…å¯†é…ç½®</h3>
<pre class="codehilite"><code class="language-bash"># ç”Ÿæˆå¯†é’¥å¯¹
ssh-keygen -t rsa -b 4096 -C &quot;admin@opsnot.com&quot;

# æ‰¹é‡åˆ†å‘å…¬é’¥ï¼ˆå»ºè®®ä½¿ç”¨æ™®é€šç”¨æˆ·ï¼Œé…åˆbecomeï¼‰
for ip in 192.168.1.{10..20}; do
    ssh-copy-id deploy@$ip  # ä½¿ç”¨deployç”¨æˆ·è€Œéroot
done

# æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨æ™®é€šç”¨æˆ· + sudoæƒé™ï¼Œé¿å…ç›´æ¥ä½¿ç”¨root</code></pre>


<h3 id="23">2.3 æ ‡å‡†ç›®å½•ç»“æ„</h3>
<pre class="codehilite"><code class="language-bash">production/
â”œâ”€â”€ ansible.cfg              # å…¨å±€é…ç½®
â”œâ”€â”€ inventory/
â”‚   â”œâ”€â”€ prod                 # ç”Ÿäº§ç¯å¢ƒ
â”‚   â””â”€â”€ test                 # æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ group_vars/              # ç»„å˜é‡
â”‚   â”œâ”€â”€ all.yml
â”‚   â””â”€â”€ webservers.yml
â”œâ”€â”€ host_vars/               # ä¸»æœºå˜é‡
â”‚   â””â”€â”€ web01.yml
â”œâ”€â”€ roles/                   # è§’è‰²ç›®å½•
â”‚   â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ app/
â”‚   â””â”€â”€ common/
â”œâ”€â”€ playbooks/               # å‰§æœ¬
â”‚   â”œâ”€â”€ deploy.yml
â”‚   â””â”€â”€ rollback.yml
â”œâ”€â”€ library/                 # è‡ªå®šä¹‰æ¨¡å—
â”‚   â””â”€â”€ check_port.py
â”œâ”€â”€ callback_plugins/        # å›è°ƒæ’ä»¶
â”‚   â””â”€â”€ dingtalk.py
â””â”€â”€ files/                   # é™æ€æ–‡ä»¶
# Structure by opsnot.com</code></pre>


<h3 id="24">2.4 æ ¸å¿ƒé…ç½®</h3>
<pre class="codehilite"><code class="language-ini"># ansible.cfg - opsnot.com
[defaults]
inventory = ./inventory/prod
host_key_checking = False
forks = 50                    # å¹¶å‘æ•°
gathering = smart             # æ™ºèƒ½æ”¶é›†facts
fact_caching = jsonfile
fact_caching_connection = /tmp/ansible_facts
fact_caching_timeout = 3600
pipelining = True             # å‡å°‘SSHè¿æ¥
retry_files_enabled = False
log_path = /var/log/ansible.log
callback_whitelist = timer, profile_tasks, dingtalk  # å¯ç”¨å›è°ƒæ’ä»¶

[ssh_connection]
ssh_args = -o ControlMaster=auto -o ControlPersist=60s</code></pre>


<h2 id="3-inventoryad-hoc">3. Inventoryä¸Ad-Hocå‘½ä»¤</h2>
<h3 id="31-inventory">3.1 é™æ€Inventory</h3>
<pre class="codehilite"><code class="language-ini"># inventory/prod
[webservers]
web01 ansible_host=192.168.1.10
web02 ansible_host=192.168.1.11

[dbservers]
db01 ansible_host=192.168.1.20

[webservers:vars]
nginx_port=80

[production:children]
webservers
dbservers

[all:vars]
ansible_user=deploy          # ä½¿ç”¨æ™®é€šç”¨æˆ·
ansible_become=yes           # è‡ªåŠ¨ææƒ
ansible_become_method=sudo
# Managed by opsnot.com</code></pre>


<h3 id="32-inventorycmdb">3.2 åŠ¨æ€Inventoryï¼ˆå¯¹æ¥CMDBï¼‰</h3>
<pre class="codehilite"><code class="language-python">#!/usr/bin/env python3
# inventory/cmdb.py - opsnot.com
# ä½¿ç”¨æ–¹æ³•ï¼šchmod +x cmdb.pyï¼Œç„¶ååœ¨ansible.cfgä¸­è®¾ç½® inventory = ./inventory/cmdb.py

import json
import requests
import sys

def get_hosts():
    try:
        hosts = requests.get('http://cmdb.opsnot.com/api/hosts', timeout=5).json()
    except Exception as e:
        # è¿”å›åˆæ³•çš„ç©ºinventoryï¼Œé¿å…AnsibleæŠ¥é”™
        print(json.dumps({'_meta': {'hostvars': {}}}), file=sys.stderr)
        print(f&quot;CMDBè¿æ¥å¤±è´¥: {e}&quot;, file=sys.stderr)
        return {'_meta': {'hostvars': {}}}

    inventory = {
        'webservers': {'hosts': []},
        'dbservers': {'hosts': []},
        'all': {'hosts': []},
        '_meta': {'hostvars': {}}
    }

    for h in hosts:
        ip = h['ip']
        inventory['all']['hosts'].append(ip)

        if h['role'] == 'web':
            inventory['webservers']['hosts'].append(ip)
        elif h['role'] == 'db':
            inventory['dbservers']['hosts'].append(ip)

        inventory['_meta']['hostvars'][ip] = {
            'ansible_host': ip,
            'ansible_user': 'deploy'
        }

    return inventory

if __name__ == '__main__':
    print(json.dumps(get_hosts(), indent=2))
    sys.exit(0)</code></pre>


<h3 id="33-ad-hoc">3.3 Ad-Hocå‘½ä»¤</h3>
<pre class="codehilite"><code class="language-bash"># æ‰¹é‡æ‰§è¡Œ
ansible all -m shell -a &quot;df -h | grep -v tmpfs&quot;
ansible webservers -m systemd -a &quot;name=nginx state=restarted&quot;

# æ–‡ä»¶åˆ†å‘
ansible webservers -m copy -a &quot;src=/tmp/nginx.conf dest=/etc/nginx/ backup=yes&quot;

# è½¯ä»¶ç®¡ç†
ansible all -m yum -a &quot;name=htop state=present&quot;

# æŸ¥çœ‹facts
ansible web01 -m setup -a &quot;filter=ansible_processor*&quot;</code></pre>


<h2 id="4-playbook">4. Playbookæ ¸å¿ƒè¯­æ³•</h2>
<h3 id="41">4.1 åŸºç¡€ç»“æ„</h3>
<pre class="codehilite"><code class="language-yaml">---
# deploy.yml - opsnot
- name: éƒ¨ç½²Webåº”ç”¨
  hosts: webservers
  become: yes
  vars:
    app_port: 8080

  tasks:
    - name: å®‰è£…Nginx
      yum:
        name: nginx
        state: present

    - name: å¯åŠ¨æœåŠ¡
      systemd:
        name: nginx
        state: started
        enabled: yes
      notify: reload nginx

  handlers:
    - name: reload nginx
      systemd:
        name: nginx
        state: reloaded</code></pre>


<h3 id="42">4.2 æ¡ä»¶ã€å¾ªç¯ä¸å˜é‡</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: æ¡ä»¶ä¸å¾ªç¯
  hosts: all
  tasks:
    # æ¡ä»¶åˆ¤æ–­
    - name: CentOSå®‰è£…
      yum:
        name: nginx
        state: present
      when: ansible_distribution == &quot;CentOS&quot;

    # å¾ªç¯å¤„ç†
    - name: æ‰¹é‡åˆ›å»ºç”¨æˆ·
      user:
        name: &quot;{{ item.name }}&quot;
        uid: &quot;{{ item.uid }}&quot;
      loop:
        - { name: 'opsnot01', uid: 2001 }
        - { name: 'opsnot02', uid: 2002 }
      # opsnot - æ‰¹é‡ç®¡ç†

# å˜é‡ä¼˜å…ˆçº§ï¼ˆä»ä½åˆ°é«˜ï¼‰
# role defaults &lt; inventoryç»„å˜é‡ &lt; inventoryä¸»æœºå˜é‡ &lt; playbook vars &lt; task vars &lt; å‘½ä»¤è¡Œ-e</code></pre>


<h3 id="43-jinja2">4.3 Jinja2æ¨¡æ¿</h3>
<pre class="codehilite"><code class="language-jinja2"># templates/nginx.conf.j2 - opsnot.com
user {{ nginx_user }};
worker_processes {{ ansible_processor_vcpus }};

events {
    worker_connections {{ worker_connections | default(1024) }};
}

http {
    {% for host in virtual_hosts %}
    server {
        listen {{ host.port }};
        server_name {{ host.domain }};
        location / {
            proxy_pass http://{{ host.backend }};
        }
    }
    {% endfor %}
}</code></pre>


<h2 id="5-role">5. Roleè§’è‰²åŒ–ç®¡ç†</h2>
<h3 id="51">5.1 æ ‡å‡†ç»“æ„</h3>
<pre class="codehilite"><code class="language-bash">roles/nginx/
â”œâ”€â”€ defaults/main.yml        # é»˜è®¤å˜é‡
â”œâ”€â”€ tasks/main.yml           # ä»»åŠ¡åˆ—è¡¨
â”œâ”€â”€ handlers/main.yml        # å¤„ç†å™¨
â”œâ”€â”€ templates/nginx.conf.j2  # æ¨¡æ¿
â”œâ”€â”€ files/                   # é™æ€æ–‡ä»¶
â””â”€â”€ meta/main.yml            # ä¾èµ–å…³ç³»</code></pre>


<h3 id="52-role">5.2 Roleç¤ºä¾‹</h3>
<pre class="codehilite"><code class="language-yaml"># roles/nginx/tasks/main.yml
---
- name: å®‰è£…Nginx
  yum:
    name: nginx
    state: present

- name: é…ç½®Nginx
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    validate: 'nginx -t -c %s'
  notify: restart nginx
  # opsnot - nginx role

# roles/nginx/handlers/main.yml
---
- name: restart nginx
  systemd:
    name: nginx
    state: restarted

# roles/nginx/defaults/main.yml
---
nginx_port: 80
nginx_user: www
# Default by opsnot.com

# ä½¿ç”¨Role - site.yml
---
- name: éƒ¨ç½²WebæœåŠ¡
  hosts: webservers
  roles:
    - nginx
    - { role: app, version: '2.0' }</code></pre>


<h2 id="6">6. ç”Ÿäº§å®æˆ˜ï¼šåº”ç”¨å‘å¸ƒ</h2>
<pre class="codehilite"><code class="language-yaml"># playbooks/deploy.yml - opsnot
---
- name: æ»šåŠ¨å‘å¸ƒåº”ç”¨
  hosts: webservers
  serial: 1                  # ä¸€æ¬¡ä¸€å°ï¼Œç¡®ä¿å•å°å¤±è´¥å³åœæ­¢

  vars:
    app_name: myapp
    app_version: &quot;{{ version | default('latest') }}&quot;
    deploy_dir: /opt/{{ app_name }}

  tasks:
    - name: ä»LBæ‘˜é™¤
      uri:
        url: &quot;http://lb.opsnot.com/api/remove/{{ inventory_hostname }}&quot;
        method: POST
      delegate_to: localhost

    - name: ç­‰å¾…è¿æ¥æ’ç©º
      wait_for:
        timeout: 30

    - name: åœæ­¢åº”ç”¨
      systemd:
        name: &quot;{{ app_name }}&quot;
        state: stopped

    - name: å¤‡ä»½å½“å‰ç‰ˆæœ¬
      archive:
        path: &quot;{{ deploy_dir }}&quot;
        dest: &quot;/backup/{{ app_name }}_{{ ansible_date_time.epoch }}.tar.gz&quot;

    - name: éƒ¨ç½²æ–°ç‰ˆæœ¬
      get_url:
        url: &quot;http://repo.opsnot.com/{{ app_name }}-{{ app_version }}.jar&quot;
        dest: &quot;{{ deploy_dir }}/{{ app_name }}.jar&quot;
        checksum: &quot;sha256:http://repo.opsnot.com/{{ app_name }}-{{ app_version }}.sha256&quot;

    - name: å¯åŠ¨åº”ç”¨
      systemd:
        name: &quot;{{ app_name }}&quot;
        state: started

    - name: å¥åº·æ£€æŸ¥
      uri:
        url: &quot;http://{{ ansible_host }}:8080/health&quot;
        status_code: 200
      retries: 10
      delay: 3
      until: result.status == 200
      register: result

    - name: åŠ å…¥LB
      uri:
        url: &quot;http://lb.opsnot.com/api/add/{{ inventory_hostname }}&quot;
        method: POST
      delegate_to: localhost

  rescue:
    - name: å›æ»š
      unarchive:
        src: &quot;/backup/{{ app_name }}_latest.tar.gz&quot;
        dest: &quot;{{ deploy_dir }}&quot;
        remote_src: yes
    - systemd:
        name: &quot;{{ app_name }}&quot;
        state: started</code></pre>


<h2 id="7">7. ç”Ÿäº§å®æˆ˜ï¼šæœåŠ¡å™¨åˆå§‹åŒ–</h2>
<pre class="codehilite"><code class="language-yaml"># playbooks/init.yml
---
- name: æœåŠ¡å™¨æ ‡å‡†åŒ–
  hosts: new_servers
  become: yes
  # æ³¨æ„ï¼šåˆå§‹åŒ–é˜¶æ®µç›´æ¥ä½¿ç”¨rootæˆ–ç³»ç»Ÿé»˜è®¤ç”¨æˆ·ï¼ˆå¦‚centos/ubuntuï¼‰
  # ä¸æŒ‡å®šbecome_userï¼Œç­‰opsnotç”¨æˆ·åˆ›å»ºåå†ä½¿ç”¨

  tasks:
    - name: ä¼˜åŒ–å†…æ ¸å‚æ•°
      sysctl:
        name: &quot;{{ item.key }}&quot;
        value: &quot;{{ item.value }}&quot;
        sysctl_set: yes
        reload: yes
      loop:
        - { key: 'net.ipv4.tcp_tw_reuse', value: '1' }
        - { key: 'net.ipv4.tcp_fin_timeout', value: '30' }
        - { key: 'net.core.somaxconn', value: '65535' }
        - { key: 'fs.file-max', value: '655350' }

    - name: ç¦ç”¨SELinuxï¼ˆæ ¹æ®éœ€æ±‚ï¼‰
      selinux:
        state: disabled
      when: ansible_selinux.status == &quot;enabled&quot;

    - name: é…ç½®æ—¶åŒº
      timezone:
        name: Asia/Shanghai

    - name: åˆ›å»ºè¿ç»´ç”¨æˆ·
      user:
        name: opsnot
        groups: wheel
        shell: /bin/bash
        password: &quot;{{ 'YourPassword' | password_hash('sha512') }}&quot;

    - name: é…ç½®SSHå…¬é’¥
      authorized_key:
        user: opsnot
        key: &quot;{{ lookup('file', 'files/opsnot.pub') }}&quot;

    - name: é…ç½®sudoæƒé™
      lineinfile:
        path: /etc/sudoers.d/opsnot
        line: &quot;opsnot ALL=(ALL) NOPASSWD: ALL&quot;
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'</code></pre>


<h2 id="8">8. æ€§èƒ½ä¼˜åŒ–æ·±åº¦å®è·µ</h2>
<h3 id="81">8.1 å¹¶å‘æ§åˆ¶ä¸è¿æ¥å¤ç”¨</h3>
<pre class="codehilite"><code class="language-ini"># ansible.cfg æ€§èƒ½ä¼˜åŒ–é…ç½® - opsnot.com
[defaults]
forks = 100                   # æ ¹æ®æ§åˆ¶æœºæ€§èƒ½è°ƒæ•´ï¼Œå»ºè®®CPUæ ¸æ•°*10
timeout = 30
host_key_checking = False
gathering = smart
fact_caching = jsonfile
fact_caching_connection = /tmp/ansible_facts
fact_caching_timeout = 86400  # 24å°æ—¶ç¼“å­˜
pipelining = True             # å…³é”®ï¼šå‡å°‘SSHå¾€è¿”æ¬¡æ•°
poll_interval = 5

[ssh_connection]
ssh_args = -o ControlMaster=auto -o ControlPersist=3600s -o PreferredAuthentications=publickey
control_path = /tmp/ansible-ssh-%%h-%%p-%%r
pipelining = True</code></pre>


<h3 id="82-facts">8.2 Factsæ”¶é›†ä¼˜åŒ–</h3>
<pre class="codehilite"><code class="language-yaml"># å®Œå…¨ç¦ç”¨factsï¼ˆæœ€å¿«ï¼‰
- name: æ— éœ€factsçš„ä»»åŠ¡
  hosts: all
  gather_facts: no
  tasks:
    - name: ç®€å•å‘½ä»¤
      shell: uptime

# åªæ”¶é›†å¿…è¦çš„facts
- name: æŒ‰éœ€æ”¶é›†facts
  hosts: all
  gather_facts: no
  tasks:
    - name: åªæ”¶é›†ç½‘ç»œå’Œç¡¬ä»¶ä¿¡æ¯
      setup:
        gather_subset:
          - '!all'          # æ’é™¤æ‰€æœ‰
          - '!any'          # æ’é™¤é»˜è®¤
          - 'network'       # åªè¦ç½‘ç»œ
          - 'hardware'      # åªè¦ç¡¬ä»¶
        filter:
          - 'ansible_eth*'  # åªè¦ethå¼€å¤´çš„ç½‘å¡
          - 'ansible_processor*'

# ä½¿ç”¨factsç¼“å­˜ï¼ˆæ¨èï¼‰
- name: åˆ©ç”¨ç¼“å­˜çš„facts
  hosts: all
  gather_facts: yes           # é¦–æ¬¡æ”¶é›†
  tasks:
    - debug:
        msg: &quot;{{ ansible_processor_vcpus }}&quot;

# æ³¨æ„ï¼šå…³é—­gather_factsåï¼Œæ¨¡æ¿ä¸­ä½¿ç”¨çš„ansible_*å˜é‡å°†ä¸å¯ç”¨
# éœ€æ‰‹åŠ¨setupæˆ–é€šè¿‡å…¶ä»–æ–¹å¼æä¾›</code></pre>


<h3 id="83">8.3 å¼‚æ­¥ä»»åŠ¡ä¸å¹¶è¡Œæ‰§è¡Œ</h3>
<pre class="codehilite"><code class="language-yaml">---
# å¼‚æ­¥æ‰§è¡Œé•¿ä»»åŠ¡ - opsnot
- name: å¼‚æ­¥ä»»åŠ¡ç¤ºä¾‹
  hosts: all
  tasks:
    # å¯åŠ¨å¤šä¸ªå¼‚æ­¥ä»»åŠ¡
    - name: å¼‚æ­¥æ‰§è¡Œå¤‡ä»½
      shell: /opt/scripts/backup.sh
      async: 3600              # æœ€é•¿è¿è¡Œ1å°æ—¶
      poll: 0                  # ä¸ç­‰å¾…ï¼Œç«‹å³è¿”å›
      register: backup_job

    - name: å¼‚æ­¥æ‰§è¡Œæ—¥å¿—å½’æ¡£
      shell: /opt/scripts/archive_logs.sh
      async: 1800
      poll: 0
      register: archive_job

    # ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡
    - name: å…¶ä»–ä»»åŠ¡ä¸å—é˜»å¡
      debug:
        msg: &quot;å¤‡ä»½å’Œå½’æ¡£åœ¨åå°è¿è¡Œ&quot;

    # æœ€åæ£€æŸ¥æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡çŠ¶æ€
    - name: æ£€æŸ¥å¤‡ä»½ä»»åŠ¡
      async_status:
        jid: &quot;{{ backup_job.ansible_job_id }}&quot;
      register: backup_result
      until: backup_result.finished
      retries: 120
      delay: 30

    - name: æ£€æŸ¥å½’æ¡£ä»»åŠ¡
      async_status:
        jid: &quot;{{ archive_job.ansible_job_id }}&quot;
      register: archive_result
      until: archive_result.finished
      retries: 60
      delay: 30

# ä½¿ç”¨strategyåŠ é€Ÿ
- name: å¹¶è¡Œç­–ç•¥
  hosts: all
  strategy: free               # å„ä¸»æœºç‹¬ç«‹æ‰§è¡Œï¼Œä¸ç­‰å¾…æ…¢èŠ‚ç‚¹
  tasks:
    - name: å®‰è£…è½¯ä»¶
      yum:
        name: &quot;{{ item }}&quot;
        state: present
      loop:
        - nginx
        - redis
        - mysql</code></pre>


<h3 id="84">8.4 æ‰¹é‡æ“ä½œä¼˜åŒ–</h3>
<pre class="codehilite"><code class="language-yaml">---
# ä½¿ç”¨with_itemsä¼˜åŒ–å¾ªç¯
- name: æ‰¹é‡å®‰è£…ä¼˜åŒ–
  hosts: all
  tasks:
    # ä¸æ¨èï¼šå¤šæ¬¡è°ƒç”¨åŒ…ç®¡ç†å™¨
    - name: é€ä¸ªå®‰è£…ï¼ˆæ…¢ï¼‰
      yum:
        name: &quot;{{ item }}&quot;
        state: present
      loop:
        - nginx
        - redis
        - mysql

    # æ¨èï¼šä¸€æ¬¡æ€§å®‰è£…
    - name: æ‰¹é‡å®‰è£…ï¼ˆå¿«ï¼‰
      yum:
        name:
          - nginx
          - redis
          - mysql
        state: present

# ä½¿ç”¨mitogenåŠ é€Ÿï¼ˆç¬¬ä¸‰æ–¹æ’ä»¶ï¼‰
# æ³¨æ„ï¼šMitogenä»…å…¼å®¹Ansible â‰¤2.14ï¼ŒAnsible 2.15+å·²ç§»é™¤åŸç”Ÿæ”¯æŒ
# pip install mitogen
# ansible.cfgä¸­æ·»åŠ ï¼š
# strategy_plugins = /path/to/mitogen/ansible_mitogen/plugins/strategy
# strategy = mitogen_linear</code></pre>


<h3 id="85">8.5 æ¨¡æ¿æ¸²æŸ“ä¼˜åŒ–</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: æ¨¡æ¿ä¼˜åŒ–
  hosts: webservers
  tasks:
    # é¿å…åœ¨å¾ªç¯ä¸­ä½¿ç”¨templateï¼ˆæ…¢ï¼‰
    - name: ä¸æ¨è
      template:
        src: config.j2
        dest: &quot;/etc/app/{{ item }}.conf&quot;
      loop: &quot;{{ servers }}&quot;

    # æ¨èï¼šä¸€æ¬¡æ¸²æŸ“ï¼ŒåŒ…å«æ‰€æœ‰é…ç½®
    - name: æ¨è
      template:
        src: all_configs.j2
        dest: /etc/app/config.conf
      vars:
        all_servers: &quot;{{ servers }}&quot;</code></pre>


<h3 id="86">8.6 é™ä½æ—¥å¿—è¾“å‡º</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: å‡å°‘æ—¥å¿—è¾“å‡º
  hosts: all
  tasks:
    - name: ä¸è®°å½•æ•æ„Ÿè¾“å‡º
      shell: some_command
      no_log: true             # ä¸è®°å½•è¾“å‡ºåˆ°æ—¥å¿—

    - name: ç®€åŒ–è¾“å‡º
      command: long_command
      changed_when: false      # ä¸æŠ¥å‘ŠchangedçŠ¶æ€
      failed_when: false       # ä¸æŠ¥å‘Šå¤±è´¥</code></pre>


<h3 id="87-profile">8.7 ä½¿ç”¨Profileåˆ†ææ€§èƒ½</h3>
<pre class="codehilite"><code class="language-bash"># å¯ç”¨profile_tasksæ’ä»¶ï¼ˆå·²åœ¨ansible.cfgä¸­é…ç½®ï¼‰
# æ‰§è¡Œplaybookä¼šè‡ªåŠ¨æ˜¾ç¤ºæ¯ä¸ªä»»åŠ¡è€—æ—¶

ansible-playbook deploy.yml

# è¾“å‡ºç¤ºä¾‹ï¼š
# TASK [å®‰è£…Nginx] ********************************
# ok: [web01]
# Tuesday 27 December 2025  10:30:45 +0800 (0:00:05.234)
# 
# PLAY RECAP ***********************************
# Playbook run took 0 days, 0 hours, 2 minutes, 15 seconds</code></pre>


<h2 id="9">9. å®‰å…¨åŠ å›º</h2>
<h3 id="91-vault">9.1 VaultåŠ å¯†æ•æ„Ÿä¿¡æ¯</h3>
<pre class="codehilite"><code class="language-bash"># åˆ›å»ºåŠ å¯†æ–‡ä»¶ - opsnot
ansible-vault create group_vars/all/vault.yml

# ç¼–è¾‘åŠ å¯†æ–‡ä»¶
ansible-vault edit group_vars/all/vault.yml

# åŠ å¯†ç°æœ‰æ–‡ä»¶
ansible-vault encrypt vars/database.yml

# æŸ¥çœ‹åŠ å¯†æ–‡ä»¶
ansible-vault view group_vars/all/vault.yml

# ä¿®æ”¹å¯†ç 
ansible-vault rekey group_vars/all/vault.yml

# ä½¿ç”¨å¯†ç æ–‡ä»¶ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
echo &quot;your_vault_password&quot; &gt; ~/.vault_pass
chmod 600 ~/.vault_pass
ansible-playbook deploy.yml --vault-password-file ~/.vault_pass</code></pre>


<pre class="codehilite"><code class="language-yaml"># group_vars/all/vault.ymlï¼ˆåŠ å¯†å†…å®¹ï¼‰
vault_db_password: &quot;SuperSecret123&quot;
vault_api_key: &quot;sk-xxxxxxxxxxxxx&quot;
vault_ssh_password: &quot;Passw0rd!&quot;

# group_vars/all/vars.ymlï¼ˆå¼•ç”¨åŠ å¯†å˜é‡ï¼‰
db_password: &quot;{{ vault_db_password }}&quot;
api_key: &quot;{{ vault_api_key }}&quot;</code></pre>


<h3 id="92">9.2 æƒé™æœ€å°åŒ–</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·éƒ¨ç½²
  hosts: all
  become: yes
  become_user: deploy        # æŒ‡å®šérootç”¨æˆ·
  become_method: sudo

  tasks:
    - name: é…ç½®æœ€å°sudoæƒé™
      lineinfile:
        path: /etc/sudoers.d/deploy
        line: &quot;{{ item }}&quot;
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'
      loop:
        - &quot;deploy ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx&quot;
        - &quot;deploy ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload nginx&quot;
        - &quot;deploy ALL=(ALL) NOPASSWD: /usr/bin/systemctl status nginx&quot;
      # åªæˆäºˆå¿…è¦çš„systemctlæƒé™ - opsnot.com</code></pre>


<h3 id="93">9.3 æ•æ„Ÿæ•°æ®ä¸è®°å½•æ—¥å¿—</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: å¤„ç†æ•æ„Ÿæ•°æ®
  hosts: all
  tasks:
    - name: è®¾ç½®æ•°æ®åº“å¯†ç 
      mysql_user:
        name: app
        password: &quot;{{ db_password }}&quot;
      no_log: true             # ä¸è®°å½•åˆ°æ—¥å¿—
      # ğŸ’¡ ç”Ÿäº§ç¯å¢ƒå¯ç”¨no_logï¼Œå¼€å‘/æµ‹è¯•ç¯å¢ƒå¯ä¸´æ—¶å…³é—­ä¾¿äºè°ƒè¯•

    - name: è°ƒç”¨API
      uri:
        url: https://api.example.com
        headers:
          Authorization: &quot;Bearer {{ api_token }}&quot;
      no_log: true</code></pre>


<h2 id="10">10. è°ƒè¯•ä¸é”™è¯¯å¤„ç†</h2>
<h3 id="101">10.1 è°ƒè¯•å‘½ä»¤</h3>
<pre class="codehilite"><code class="language-bash"># è¯­æ³•æ£€æŸ¥
ansible-playbook deploy.yml --syntax-check

# æ¨¡æ‹Ÿè¿è¡Œï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
ansible-playbook deploy.yml --check --diff

# åˆ—å‡ºå—å½±å“ä¸»æœº
ansible-playbook deploy.yml --list-hosts

# åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡
ansible-playbook deploy.yml --list-tasks

# åˆ—å‡ºæ‰€æœ‰æ ‡ç­¾
ansible-playbook deploy.yml --list-tags

# ä»æŒ‡å®šä»»åŠ¡å¼€å§‹
ansible-playbook deploy.yml --start-at-task=&quot;å¯åŠ¨åº”ç”¨&quot;

# å•æ­¥æ‰§è¡Œ
ansible-playbook deploy.yml --step

# è¯¦ç»†è¾“å‡º - opsnot
ansible-playbook deploy.yml -v     # åŸºæœ¬ä¿¡æ¯
ansible-playbook deploy.yml -vv    # è¯¦ç»†ä¿¡æ¯
ansible-playbook deploy.yml -vvv   # è¿æ¥è°ƒè¯•
ansible-playbook deploy.yml -vvvv  # SSHè¯¦ç»†

# åªæ‰§è¡ŒæŒ‡å®šæ ‡ç­¾
ansible-playbook deploy.yml --tags=&quot;deploy,restart&quot;

# è·³è¿‡æŒ‡å®šæ ‡ç­¾
ansible-playbook deploy.yml --skip-tags=&quot;backup&quot;

# é™åˆ¶æ‰§è¡Œä¸»æœº
ansible-playbook deploy.yml --limit=&quot;web01,web02&quot;</code></pre>


<h3 id="102-playbook">10.2 Playbookå†…è°ƒè¯•</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: è°ƒè¯•æŠ€å·§
  hosts: all
  tasks:
    # æ‰“å°å˜é‡
    - debug:
        var: ansible_facts
        verbosity: 2           # éœ€è¦-vvæ‰æ˜¾ç¤º

    - debug:
        msg: &quot;ä¸»æœº: {{ inventory_hostname }}, IP: {{ ansible_host }}&quot;

    # æ¡ä»¶æ–­è¨€
    - assert:
        that:
          - ansible_distribution == &quot;CentOS&quot;
          - ansible_distribution_major_version &gt;= &quot;7&quot;
          - ansible_memtotal_mb &gt;= 4096
        fail_msg: &quot;ç³»ç»Ÿä¸æ»¡è¶³è¦æ±‚&quot;
        success_msg: &quot;ç³»ç»Ÿæ£€æŸ¥é€šè¿‡&quot;

    # æš‚åœæ‰§è¡Œ
    - pause:
        prompt: &quot;å³å°†æ‰§è¡Œå±é™©æ“ä½œï¼Œç¡®è®¤åæŒ‰å›è½¦ç»§ç»­&quot;
        seconds: 10            # æˆ–è‡ªåŠ¨ç­‰å¾…10ç§’

    # å¤±è´¥ç»§ç»­
    - command: /opt/scripts/may_fail.sh
      ignore_errors: yes       # å¤±è´¥ä¹Ÿç»§ç»­
      register: result

    - debug:
        msg: &quot;å‘½ä»¤æ‰§è¡Œå¤±è´¥: {{ result.stderr }}&quot;
      when: result.failed</code></pre>


<h3 id="103">10.3 é”™è¯¯å¤„ç†ä¸å›æ»š</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: å®Œæ•´é”™è¯¯å¤„ç†
  hosts: webservers
  tasks:
    - block:
        - name: å°è¯•éƒ¨ç½²
          command: /opt/scripts/deploy.sh
          register: deploy_result

        - name: éªŒè¯éƒ¨ç½²
          uri:
            url: &quot;http://localhost:8080/health&quot;
            status_code: 200

      rescue:
        - name: éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š
          command: /opt/scripts/rollback.sh
          register: rollback_result

        - name: å‘é€å‘Šè­¦é‚®ä»¶
          mail:
            host: smtp.opsnot.com
            port: 587
            username: alert@opsnot.com
            password: &quot;{{ vault_smtp_password }}&quot;
            to: ops@opsnot.com
            subject: &quot;éƒ¨ç½²å¤±è´¥å‘Šè­¦ - {{ inventory_hostname }}&quot;
            body: |
              éƒ¨ç½²å¤±è´¥è¯¦æƒ…:
              ä¸»æœº: {{ inventory_hostname }}
              é”™è¯¯: {{ deploy_result.stderr }}
              å›æ»š: {{ rollback_result.stdout }}

        - name: é’‰é’‰é€šçŸ¥
          uri:
            url: &quot;https://oapi.dingtalk.com/robot/send?access_token={{ dingtalk_token }}&quot;
            method: POST
            body_format: json
            body:
              msgtype: &quot;text&quot;
              text:
                content: &quot;Ansibleéƒ¨ç½²å¤±è´¥\nä¸»æœº: {{ inventory_hostname }}\næ—¶é—´: {{ ansible_date_time.iso8601 }}&quot;

      always:
        - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          file:
            path: &quot;{{ item }}&quot;
            state: absent
          loop:
            - /tmp/deploy_*
            - /tmp/rollback_*

        - name: è®°å½•å®¡è®¡æ—¥å¿—
          lineinfile:
            path: /var/log/ansible_audit.log
            line: &quot;{{ ansible_date_time.iso8601 }} | {{ ansible_user_id }} | {{ inventory_hostname }} | deploy | {{ 'success' if deploy_result.rc == 0 else 'failed' }}&quot;
            create: yes</code></pre>


<h2 id="11_1">11. é«˜çº§æŠ€å·§</h2>
<h3 id="111">11.1 ä¿è¯å¹‚ç­‰æ€§</h3>
<pre class="codehilite"><code class="language-yaml"># é”™è¯¯ç¤ºä¾‹ï¼ˆéå¹‚ç­‰ï¼‰
- name: ä¸è¦è¿™æ ·åš
  shell: echo &quot;config=value&quot; &gt;&gt; /etc/app.conf

# æ­£ç¡®ç¤ºä¾‹ï¼ˆå¹‚ç­‰ï¼‰
- name: æ¨èåšæ³•
  lineinfile:
    path: /etc/app.conf
    line: &quot;config=value&quot;
    regexp: '^config='         # YAMLä¸­å»ºè®®ç”¨å¼•å·
    state: present</code></pre>


<h3 id="112">11.2 å¾ªç¯ä¸æ¡ä»¶çš„ç»„åˆ</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: å¾ªç¯æ¡ä»¶ç¤ºä¾‹
  hosts: all
  tasks:
    # whenåœ¨taskçº§åˆ« - æ•´ä¸ªä»»åŠ¡åˆ¤æ–­ä¸€æ¬¡
    - name: CentOSä¸“ç”¨
      yum:
        name: &quot;{{ item }}&quot;
        state: present
      loop: [gcc, make, git]
      when: ansible_distribution == &quot;CentOS&quot;

    # whenåœ¨itemçº§åˆ« - æ¯ä¸ªitemåˆ¤æ–­ä¸€æ¬¡
    - name: æ¡ä»¶å®‰è£…
      yum:
        name: &quot;{{ item.name }}&quot;
        state: present
      loop:
        - { name: 'nginx', install: true, env: 'prod' }
        - { name: 'apache', install: false, env: 'test' }
        - { name: 'redis', install: true, env: 'prod' }
      when: 
        - item.install
        - item.env == env_type</code></pre>


<h3 id="113">11.3 è‡ªå®šä¹‰æ¨¡å—</h3>
<pre class="codehilite"><code class="language-python">#!/usr/bin/python
# library/check_port.py - opsnot.com
# å°†æ­¤æ–‡ä»¶æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•çš„library/æ–‡ä»¶å¤¹ä¸­ï¼ŒAnsibleä¼šè‡ªåŠ¨åŠ è½½

from ansible.module_utils.basic import AnsibleModule
import socket

def check_port(host, port):
    &quot;&quot;&quot;æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾&quot;&quot;&quot;
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(2)
    result = sock.connect_ex((host, port))
    sock.close()
    return result == 0

def main():
    module = AnsibleModule(
        argument_spec=dict(
            host=dict(required=True, type='str'),
            port=dict(required=True, type='int'),
            timeout=dict(required=False, type='int', default=2)
        ),
        supports_check_mode=True
    )

    host = module.params['host']
    port = module.params['port']

    if module.check_mode:
        module.exit_json(changed=False, msg=&quot;Check mode&quot;)

    is_open = check_port(host, port)

    if is_open:
        module.exit_json(
            changed=False,
            msg=f&quot;Port {port} on {host} is open&quot;,
            port=port,
            host=host,
            status='open'
        )
    else:
        module.fail_json(
            msg=f&quot;Port {port} on {host} is closed&quot;,
            port=port,
            host=host,
            status='closed'
        )

if __name__ == '__main__':
    main()</code></pre>


<p>ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—ï¼š</p>
<pre class="codehilite"><code class="language-yaml">---
- name: ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—
  hosts: all
  tasks:
    - name: æ£€æŸ¥MySQLç«¯å£
      check_port:
        host: &quot;{{ ansible_host }}&quot;
        port: 3306
      register: mysql_port

    - debug:
        msg: &quot;MySQLç«¯å£çŠ¶æ€: {{ mysql_port.status }}&quot;</code></pre>


<h3 id="114">11.4 é’‰é’‰é€šçŸ¥æ’ä»¶</h3>
<pre class="codehilite"><code class="language-python"># callback_plugins/dingtalk.py
# åœ¨ansible.cfgä¸­æ·»åŠ : callback_whitelist = dingtalk
from ansible.plugins.callback import CallbackBase
import requests
import json
import os

class CallbackModule(CallbackBase):
    &quot;&quot;&quot;
    é’‰é’‰é€šçŸ¥æ’ä»¶ - opsnot.com
    ä½¿ç”¨æ–¹æ³•ï¼šexport DINGTALK_WEBHOOK=&quot;https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN&quot;
    &quot;&quot;&quot;
    CALLBACK_VERSION = 2.0
    CALLBACK_TYPE = 'notification'
    CALLBACK_NAME = 'dingtalk'

    def __init__(self):
        super(CallbackModule, self).__init__()
        # ä»ç¯å¢ƒå˜é‡è¯»å–webhookï¼Œé¿å…ç¡¬ç¼–ç 
        self.webhook = os.getenv('DINGTALK_WEBHOOK', '')
        self.disabled = not self.webhook

        if self.disabled:
            self._display.warning(&quot;é’‰é’‰webhookæœªé…ç½®ï¼Œé€šçŸ¥åŠŸèƒ½å·²ç¦ç”¨&quot;)

    def send_msg(self, msg):
        &quot;&quot;&quot;å‘é€é’‰é’‰æ¶ˆæ¯&quot;&quot;&quot;
        if self.disabled:
            return

        try:
            data = {
                &quot;msgtype&quot;: &quot;markdown&quot;,
                &quot;markdown&quot;: {
                    &quot;title&quot;: &quot;Ansibleæ‰§è¡Œé€šçŸ¥&quot;,
                    &quot;text&quot;: f&quot;### Ansibleé€šçŸ¥\n{msg}\n\n&gt; opsnot.com&quot;
                }
            }
            requests.post(self.webhook, json=data, timeout=5)
        except Exception as e:
            self._display.warning(f&quot;é’‰é’‰é€šçŸ¥å¤±è´¥: {e}&quot;)

    def v2_playbook_on_start(self, playbook):
        &quot;&quot;&quot;Playbookå¼€å§‹&quot;&quot;&quot;
        msg = f&quot;**Playbookå¯åŠ¨**\n\n- æ–‡ä»¶: {playbook._file_name}&quot;
        self.send_msg(msg)

    def v2_playbook_on_stats(self, stats):
        &quot;&quot;&quot;Playbookç»“æŸ&quot;&quot;&quot;
        hosts = sorted(stats.processed.keys())
        summary = []

        for h in hosts:
            s = stats.summarize(h)
            summary.append(
                f&quot;- {h}: âœ…{s['ok']} âŒ{s['failures']} âš ï¸{s['changed']}&quot;
            )

        msg = f&quot;**Playbookå®Œæˆ**\n\n{''.join(summary)}&quot;
        self.send_msg(msg)</code></pre>


<h3 id="115-tags">11.5 ä½¿ç”¨Tagsç»„ç»‡ä»»åŠ¡</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: å®Œæ•´éƒ¨ç½²æµç¨‹
  hosts: webservers
  tasks:
    - name: å¤‡ä»½æ•°æ®
      archive:
        path: /opt/app
        dest: /backup/app-{{ ansible_date_time.date }}.tar.gz
      tags:
        - backup
        - pre-deploy

    - name: åœæ­¢æœåŠ¡
      systemd:
        name: app
        state: stopped
      tags:
        - deploy
        - stop

    - name: éƒ¨ç½²åº”ç”¨
      copy:
        src: app.tar.gz
        dest: /opt/app/
      tags:
        - deploy

    - name: å¯åŠ¨æœåŠ¡
      systemd:
        name: app
        state: started
      tags:
        - deploy
        - start

    - name: éªŒè¯éƒ¨ç½²
      uri:
        url: http://localhost:8080/health
      tags:
        - deploy
        - verify
        - always          # æ€»æ˜¯æ‰§è¡Œ

    - name: æ¸…ç†æ—§å¤‡ä»½
      shell: find /backup -name &quot;app-*&quot; -mtime +7 -delete
      tags:
        - cleanup
        - never           # é»˜è®¤ä¸æ‰§è¡Œ

# ä½¿ç”¨æ–¹å¼ï¼š
# ansible-playbook deploy.yml --tags=&quot;deploy&quot;        # åªæ‰§è¡Œéƒ¨ç½²
# ansible-playbook deploy.yml --tags=&quot;backup,deploy&quot; # å¤‡ä»½+éƒ¨ç½²
# ansible-playbook deploy.yml --skip-tags=&quot;backup&quot;   # è·³è¿‡å¤‡ä»½
# ansible-playbook deploy.yml --tags=&quot;never,cleanup&quot; # æ‰§è¡Œæ¸…ç†</code></pre>


<h3 id="116">11.6 å˜é‡æ–‡ä»¶åŠ è½½ç­–ç•¥</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: å¤šç¯å¢ƒå˜é‡ç®¡ç†
  hosts: &quot;{{ env }}&quot;
  vars_files:
    - &quot;vars/common.yml&quot;
    - &quot;vars/{{ env }}.yml&quot;      # æ ¹æ®ç¯å¢ƒåŠ è½½ä¸åŒé…ç½®
    - &quot;vars/secrets.yml&quot;

  tasks:
    - name: æ˜¾ç¤ºç¯å¢ƒ
      debug:
        msg: &quot;å½“å‰ç¯å¢ƒ: {{ env }}, æ•°æ®åº“: {{ db_host }}&quot;

# æ‰§è¡Œï¼šansible-playbook deploy.yml -e &quot;env=production&quot;</code></pre>


<h3 id="117">11.7 ä½¿ç”¨å§”æ‰˜å’Œæœ¬åœ°æ‰§è¡Œ</h3>
<pre class="codehilite"><code class="language-yaml">---
- name: å§”æ‰˜ä»»åŠ¡
  hosts: webservers
  tasks:
    # åœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œ
    - name: ä»æ§åˆ¶èŠ‚ç‚¹ä¸‹è½½æ–‡ä»¶
      get_url:
        url: http://repo.opsnot.com/app.tar.gz
        dest: /tmp/app.tar.gz
      delegate_to: localhost
      run_once: true           # åªæ‰§è¡Œä¸€æ¬¡

    # åœ¨ç‰¹å®šä¸»æœºæ‰§è¡Œ
    - name: æ›´æ–°æ•°æ®åº“
      mysql_db:
        name: myapp
        state: present
      delegate_to: &quot;{{ groups['dbservers'][0] }}&quot;
      run_once: true

    # æœ¬åœ°æ“ä½œ
    - name: æœ¬åœ°å‘½ä»¤
      local_action:
        module: command
        cmd: echo &quot;éƒ¨ç½²åˆ° {{ inventory_hostname }}&quot;</code></pre>


<h3 id="118">11.8 å¸¸è§é—®é¢˜æ’æŸ¥</h3>
<p><strong>é—®é¢˜1ï¼šSSHè¿æ¥è¶…æ—¶</strong></p>
<pre class="codehilite"><code class="language-bash"># æ£€æŸ¥SSHé…ç½®
ansible all -m ping -vvv

# ä¸´æ—¶å¢åŠ è¶…æ—¶æ—¶é—´
ansible all -m ping -T 60

# æˆ–ä¿®æ”¹ansible.cfg
[defaults]
timeout = 60</code></pre>


<p><strong>é—®é¢˜2ï¼šFactsæ”¶é›†æ…¢</strong></p>
<pre class="codehilite"><code class="language-yaml"># å…³é—­factsæˆ–ä½¿ç”¨ç¼“å­˜
- hosts: all
  gather_facts: no
  # æˆ–
  gather_facts: yes  # é…åˆfact_cachingä½¿ç”¨</code></pre>


<p><strong>é—®é¢˜3ï¼šå˜é‡æœªå®šä¹‰</strong></p>
<pre class="codehilite"><code class="language-yaml"># ä½¿ç”¨defaultè¿‡æ»¤å™¨
- debug:
    msg: &quot;{{ some_var | default('é»˜è®¤å€¼') }}&quot;

# æˆ–ä½¿ç”¨definedæµ‹è¯•
- debug:
    msg: &quot;{{ some_var }}&quot;
  when: some_var is defined</code></pre>


<p><strong>é—®é¢˜4ï¼šHandleræœªè§¦å‘</strong></p>
<pre class="codehilite"><code class="language-yaml"># Handleråªåœ¨ä»»åŠ¡changedæ—¶è§¦å‘
# å¼ºåˆ¶è§¦å‘å¯ä»¥ç”¨meta
- meta: flush_handlers</code></pre>


<p><strong>é—®é¢˜5ï¼šæƒé™é—®é¢˜</strong></p>
<pre class="codehilite"><code class="language-yaml"># ç¡®ä¿becomeé…ç½®æ­£ç¡®
- name: éœ€è¦rootæƒé™çš„ä»»åŠ¡
  command: systemctl restart nginx
  become: yes
  become_method: sudo
  become_user: root</code></pre>


<h2 id="_1">æ€»ç»“</h2>
<p>Ansibleå…¥é—¨é—¨æ§›è¾ƒä½ï¼Œä½†åŠŸèƒ½å¼ºå¤§ï¼Œç»ä¹…ä¸è¡°ï¼Œå®ä¸ºè‡ªåŠ¨åŒ–è¿ç»´ä¹‹åˆ©å™¨ã€‚å°¤å…¶ä»¥ä¸‹å‡ ç‚¹ï¼Œæ·±å—è¿ç»´ä¼™ä¼´ä»¬å–œçˆ±<br>
- <strong>ç®€å•</strong>ï¼šSSH + YAMLï¼Œå­¦ä¹ æˆæœ¬ä½<br>
- <strong>æ— ä¾µå…¥</strong>ï¼šæ— éœ€agentï¼Œå³ç”¨å³èµ°<br>
- <strong>å¹‚ç­‰æ€§</strong>ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´<br>
- <strong>å¯æ‰©å±•</strong>ï¼šæ¨¡å—ã€æ’ä»¶ã€åŠ¨æ€Inventory<br></p>
<p>è‡ªåŠ¨åŒ–æ˜¯ä¸ºäº†è§£æ”¾åŒæ‰‹ï¼ŒåŒæ—¶å®‰å…¨ã€å¤Ÿç”¨ã€ç¨³å®šã€å¯ç»´æŠ¤ä¹ƒæ˜¯æ ¹æœ¬ï¼ŒæŒæ¡è¿™ç¯‡ï¼Œè¿ç»´è‡ªåŠ¨åŒ–ä¹‹è·¯æ›´åŠ æ¸¸åˆƒæœ‰ä½™</p>
<p>æ›´å¤šlinuxè¿ç»´å¼ºå¤§å·¥å…·æŠ€å·§ï¼Œè¯·çœ‹å¾€æœŸæ–‡ç« ï¼š<br>
<a href="https://blog.opsnot.com/tech/strace-guide-system-call-tracing.html" target="_blank">Straceå‘½ä»¤ï¼ŒLinuxç³»ç»Ÿè°ƒç”¨è¿½è¸ªç¥å™¨ï¼</a><br>
<a href="https://blog.opsnot.com/tech/shell-command-line-expansion.html" target="_blank">è¿ç»´æ‹¿æ‰‹ç»æ´»ä¹‹ - Shellå‘½ä»¤è¡Œå±•å¼€å®æˆ˜æ‰‹å†Œ</a><br>
<a href="https://blog.opsnot.com/tech/understanding-lsof-and-file-descriptors-in-linux.html" target="_blank">è¿½è¸ªæ‰“å¼€æ–‡ä»¶çš„ç‘å£«å†›åˆ€ - lsof è¿ç»´å®æ“æ‰‹å†Œ</a><br>
<a href="https://blog.opsnot.com/tech/tcpdump-guide-network-troubleshooting.html" target="_blank">è¿ç»´ç«çœ¼é‡‘ç›ä¹‹ - tcpdumpæŠ“åŒ…å®æ“æ‰‹å†Œ</a></p>
<blockquote>
<p>æœ¬æ–‡ç”± opsnot.com æ•´ç†ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œå–œæ¬¢å°±å…³æ³¨ä¸€ä¸‹å§ï¼</p>
</blockquote>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tech/ansible-overview-and-best-practices.html">ğŸ“… 2025-12-27</a></li>
          </ul>
        </div>

        <hr>

        <div class="pagination">
            <a href="https://blog.opsnot.com/tech/direct-k8s-api-operations.html" class="pagination-item prev-page">
                <span class="pagination-arrow">â†</span>
                <span class="pagination-text">ä¸Šä¸€ç¯‡ï¼š<br>ç»•è¿‡kubectlï¼Œç›´æ¥æ“ä½œK8s APIçš„æ­£ç¡®å§¿åŠ¿ï¼</span>
            </a>
            <a href="/archive.html" class="pagination-item next-page">
                <span class="pagination-text">ä¸‹ä¸€ç¯‡ï¼š<br>æ–‡ç« åˆ—è¡¨</span>
                <span class="pagination-arrow">â†’</span>
            </a>
        </div>

        

        

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© opsnot</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <script defer src="https://umami.opsnot.com/script.js" data-website-id="b1df419f-de4e-4b55-82fc-2aebae58afc7"></script>
</body>
</html>